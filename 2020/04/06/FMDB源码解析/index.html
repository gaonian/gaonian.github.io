<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>FMDB源码解析 | GN</title><meta name="description" content="FMDB源码解析"><meta name="author" content="GN"><meta name="copyright" content="GN"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="FMDB源码解析"><meta name="twitter:description" content="FMDB源码解析"><meta name="twitter:image" content="https://raw.githubusercontent.com/gaonian/HexoDocument/master/iOS/SQLite/fmdb_image/FMDB.png"><meta property="og:type" content="article"><meta property="og:title" content="FMDB源码解析"><meta property="og:url" content="http://lmzcool.top/2020/04/06/FMDB%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"><meta property="og:site_name" content="GN"><meta property="og:description" content="FMDB源码解析"><meta property="og:image" content="https://raw.githubusercontent.com/gaonian/HexoDocument/master/iOS/SQLite/fmdb_image/FMDB.png"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://lmzcool.top/2020/04/06/FMDB%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"><link rel="prev" title="SQLite常用API（C）" href="http://lmzcool.top/2020/04/06/SQLite%E5%B8%B8%E7%94%A8API(C)/"><link rel="next" title="SQLite接口介绍" href="http://lmzcool.top/2020/04/06/SQLite%E6%8E%A5%E5%8F%A3%E4%BB%8B%E7%BB%8D(C)/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: false,
  highlightLang: false,
  highlightShrink: 'none',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">15</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">4</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#概要"><span class="toc-number">1.</span> <span class="toc-text">概要</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FMDatabase"><span class="toc-number">2.</span> <span class="toc-text">FMDatabase</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-FMDatabase初始化"><span class="toc-number">2.1.</span> <span class="toc-text">1. FMDatabase初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#init"><span class="toc-number">2.1.1.</span> <span class="toc-text">init</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#open"><span class="toc-number">2.1.2.</span> <span class="toc-text">open</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#close"><span class="toc-number">2.1.3.</span> <span class="toc-text">close</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-query-查询"><span class="toc-number">2.2.</span> <span class="toc-text">2. query(查询)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-update-插入、更新、删除"><span class="toc-number">2.3.</span> <span class="toc-text">3. update(插入、更新、删除)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Transaction-事务"><span class="toc-number">2.4.</span> <span class="toc-text">4. Transaction (事务)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FMStatement"><span class="toc-number">3.</span> <span class="toc-text">FMStatement</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#close-1"><span class="toc-number">3.1.</span> <span class="toc-text">close</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reset"><span class="toc-number">3.2.</span> <span class="toc-text">reset</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FMResultSet"><span class="toc-number">4.</span> <span class="toc-text">FMResultSet</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#next"><span class="toc-number">4.1.</span> <span class="toc-text">next</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#resultDictionary"><span class="toc-number">4.2.</span> <span class="toc-text">resultDictionary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xxxForColumn"><span class="toc-number">4.3.</span> <span class="toc-text">xxxForColumn:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xxxForColumnIndex"><span class="toc-number">4.4.</span> <span class="toc-text">xxxForColumnIndex:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FMDatabaseQueue"><span class="toc-number">5.</span> <span class="toc-text">FMDatabaseQueue</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FMDatabaseQueue初始化"><span class="toc-number">5.1.</span> <span class="toc-text">FMDatabaseQueue初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常用操作方法"><span class="toc-number">5.2.</span> <span class="toc-text">常用操作方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#inDatabase"><span class="toc-number">5.2.1.</span> <span class="toc-text">- inDatabase:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#inTransaction"><span class="toc-number">5.2.2.</span> <span class="toc-text">- inTransaction:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#inSavePoint"><span class="toc-number">5.2.3.</span> <span class="toc-text">- inSavePoint:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">6.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://raw.githubusercontent.com/gaonian/HexoDocument/master/iOS/SQLite/fmdb_image/FMDB.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">GN</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">FMDB源码解析</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-04-06 19:51:18"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-04-06</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-05-12 23:11:53"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-05-12</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/SQL/">SQL</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/2020/04/06/FMDB%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/2020/04/06/FMDB%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" itemprop="commentCount"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>FMDB是iOS上针对sqlite3封装的数据库框架，简单使用，支持多线程安全操作，以OC的方式封装了sqlite3的C语言api。</p>
<p><img src="/" class="lazyload" data-src="https://raw.githubusercontent.com/gaonian/HexoDocument/master/iOS/SQLite/fmdb_image/FMDB.png"  alt=""></p>
<p>FMDB代码并不算多，只有几个类。 下面分别介绍几个类的主要作用</p>
<ul>
<li><p><code>FMDatabase</code> </p>
<p>表示单个SQLite数据库，用于执行sql语句。不要在多线程下使用单个的FMDatabase，多线程下应使用FMDatabaseQueue</p>
</li>
<li><p><code>FMResultSet</code></p>
<p> 表示在FMDatabase上执行查询的结果</p>
</li>
<li><p><code>FMDatabaseQueue</code></p>
<p> 如果要在多线程上执行查询和更新，则需要使用此类。</p>
</li>
<li><p><code>FMStatement</code></p>
<p>sqlite_stmt 的包装类</p>
</li>
<li><p><code>FMDatabasePool</code> </p>
<p> FMDatabase对象池，建议使用FMDatabaseQueue，不要使用此类</p>
</li>
</ul>
<h2 id="FMDatabase"><a href="#FMDatabase" class="headerlink" title="FMDatabase"></a>FMDatabase</h2><p>FMDatabase是主要的类，负责和数据库交互。 FMDatabaseQueue、FMDatabasePool内部都是调用的这个类处理sql。</p>
<p>主要从四个方面来讲解FMDatabase类</p>
<ul>
<li>初始化</li>
<li>query (查询)</li>
<li>update (更新、删除、插入等)</li>
<li>transaction (事务)</li>
</ul>
<h3 id="1-FMDatabase初始化"><a href="#1-FMDatabase初始化" class="headerlink" title="1. FMDatabase初始化"></a>1. FMDatabase初始化</h3><h4 id="init"><a href="#init" class="headerlink" title="init"></a>init</h4><p>先来看一个初始化的例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NSString *docsPath &#x3D; NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES)[0];</span><br><span class="line">NSString *dbPath   &#x3D; [docsPath stringByAppendingPathComponent:@&quot;test.db&quot;];</span><br><span class="line">FMDatabase *db     &#x3D; [FMDatabase databaseWithPath:dbPath];</span><br></pre></td></tr></table></figure>

<p>找到沙盒内的db文件，然后调用databaseWithPath进行初始化，传入db路径path。</p>
<p>初始化主要有以下几种方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">+ databaseWithPath:</span><br><span class="line">+ databaseWithURL:</span><br><span class="line">– initWithPath:</span><br><span class="line">– initWithURL:</span><br></pre></td></tr></table></figure>

<p>但最后调用的是 <code>- initWithURL:</code> 。内部主要是初始化一些变量。</p>
<h4 id="open"><a href="#open" class="headerlink" title="open"></a>open</h4><p>初始化完毕之后就要打开数据库，调用 <code>- open</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FMDatabase *db &#x3D; [FMDatabase databaseWithPath:[self path]];</span><br><span class="line"></span><br><span class="line">if (![db open]) &#123;</span><br><span class="line">  NSLog(@&quot;数据库打开失败&quot;);</span><br><span class="line">  return;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)<span class="built_in">open</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (_isOpen) &#123;</span><br><span class="line">        <span class="keyword">return</span> YES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if we previously tried to open and it failed, make sure to close it before we try again</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (_db) &#123;</span><br><span class="line">        [self <span class="built_in">close</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// now open database</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打开数据库</span></span><br><span class="line">    <span class="keyword">int</span> err = sqlite3_open([self sqlitePath], (sqlite3**)&amp;_db );</span><br><span class="line">    <span class="keyword">if</span>(err != SQLITE_OK) &#123;</span><br><span class="line">        NSLog(@<span class="string">"error opening!: %d"</span>, err);</span><br><span class="line">        <span class="keyword">return</span> NO;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (_maxBusyRetryTimeInterval &gt; <span class="number">0.0</span>) &#123;</span><br><span class="line">        <span class="comment">// set the handler</span></span><br><span class="line">        [self setMaxBusyRetryTimeInterval:_maxBusyRetryTimeInterval];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _isOpen = YES;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> YES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先判断是否已经打开。接着如果db已经存在就先进行close。</p>
<p>打开数据库调用的 <code>sqlite3_open</code> 方法，此方式第一个参数为数据库path，第二个参数返回数据库连接句柄*ppDb，存储数据库连接句柄在_db内。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SQLITE_API <span class="keyword">int</span> <span class="title">sqlite3_open</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">const</span> <span class="keyword">char</span> *filename,   <span class="comment">/* Database filename (UTF-8) */</span></span></span></span><br><span class="line"><span class="function"><span class="params">  sqlite3 **ppDb          <span class="comment">/* OUT: SQLite db handle */</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>数据库打开成功返回<code>SQLITE_OK</code>，如果失败，可通过<code>sqlite3_errmsg</code>获取失败描述。</p>
<p>此外还有两个方法用于打开数据库：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">– openWithFlags:</span><br><span class="line">– openWithFlags:vfs:</span><br></pre></td></tr></table></figure>

<p>这个方法内部是通过调用 <code>sqlite3_open_v2</code> 来打开数据库。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SQLITE_API <span class="keyword">int</span> <span class="title">sqlite3_open_v2</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">const</span> <span class="keyword">char</span> *filename,   <span class="comment">/* Database filename (UTF-8) */</span></span></span></span><br><span class="line"><span class="function"><span class="params">  sqlite3 **ppDb,         <span class="comment">/* OUT: SQLite db handle */</span></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">int</span> flags,              <span class="comment">/* Flags */</span></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">const</span> <span class="keyword">char</span> *zVfs        <span class="comment">/* Name of VFS module to use */</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>sqlite3_open_v2()</code> 接口的工作方式与 <code>sqlite3_open()</code> 类似，只是它接受两个额外的参数来控制新的数据库连接。<code>sqlite3_open_v2()</code> 的flags参数必须至少包含以下三种标志组合之一：</p>
<ul>
<li><p>SQLITE_OPEN_READONLY</p>
<p>数据库以只读模式打开。如果数据库不存在，则返回错误。</p>
</li>
<li><p>SQLITE_OPEN_READWRITE</p>
<p>如果可能，将打开数据库进行读写，或者仅当文件受操作系统写保护时才进行读操作。无论哪种情况，数据库必须已经存在，否则将返回错误。</p>
</li>
<li><p>SQLITE_OPEN_READWRITE | SQLITE_OPEN_CREATE</p>
<p>打开数据库进行读写操作，如果数据库不存在，则创建数据库。这是始终用于sqlite3_open() 和 sqlite3_open16() 的行为。</p>
</li>
</ul>
<p><code>sqlite3_open_v2()</code> 的第四个参数是定义新数据库连接应使用的操作系统接口的sqlite3_vfs对象的名称。如果第四个参数是空指针，则使用默认的sqlite3 vfs对象。</p>
<h4 id="close"><a href="#close" class="headerlink" title="close"></a>close</h4><p>无论打开数据库连接时是否发生错误，当不再需要时，都应调用 <code>sqlite3_close</code> 来释放相关联的资源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)close &#123;</span><br><span class="line">    &#x2F;&#x2F; 1. 清空statement对象，释放prepared对象</span><br><span class="line">    [self clearCachedStatements];</span><br><span class="line">    &#x2F;&#x2F; 2. 清空resultset</span><br><span class="line">    [self closeOpenResultSets];</span><br><span class="line">    </span><br><span class="line">    if (!_db) &#123;</span><br><span class="line">        return YES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    int  rc;</span><br><span class="line">    BOOL retry;</span><br><span class="line">    BOOL triedFinalizingOpenStatements &#x3D; NO;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 3. 关闭数据库连接</span><br><span class="line">    do &#123;</span><br><span class="line">        retry   &#x3D; NO;</span><br><span class="line">        rc      &#x3D; sqlite3_close(_db);</span><br><span class="line">        if (SQLITE_BUSY &#x3D;&#x3D; rc || SQLITE_LOCKED &#x3D;&#x3D; rc) &#123;</span><br><span class="line">            if (!triedFinalizingOpenStatements) &#123;</span><br><span class="line">                triedFinalizingOpenStatements &#x3D; YES;</span><br><span class="line">                sqlite3_stmt *pStmt;</span><br><span class="line">                while ((pStmt &#x3D; sqlite3_next_stmt(_db, nil)) !&#x3D;0) &#123;</span><br><span class="line">                    NSLog(@&quot;Closing leaked statement&quot;);</span><br><span class="line">                    sqlite3_finalize(pStmt);</span><br><span class="line">                    retry &#x3D; YES;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (SQLITE_OK !&#x3D; rc) &#123;</span><br><span class="line">            NSLog(@&quot;error closing!: %d&quot;, rc);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    while (retry);</span><br><span class="line">    </span><br><span class="line">    _db &#x3D; nil;</span><br><span class="line">    _isOpen &#x3D; false;</span><br><span class="line">    </span><br><span class="line">    return YES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>close方法内部主要是清空prepared语句和结果集，最后关闭数据库连接</p>
<h3 id="2-query-查询"><a href="#2-query-查询" class="headerlink" title="2. query(查询)"></a>2. query(查询)</h3><p>数据库打开之后，我们就可以执行sql操作了。首先来讲查询操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FMResultSet *rs &#x3D; [db executeQuery:@&quot;select * from city&quot;];</span><br><span class="line">while ([rs next]) &#123;</span><br><span class="line">    NSLog(@&quot;%@&quot;, [rs resultDictionary]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的例子是从city表内查找所有数据，然后执行遍历打印操作</p>
<p>首先来看 <code>executeQurey:</code> 方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (FMResultSet *)executeQuery:(NSString*)sql, ... &#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    va_start(args, sql);</span><br><span class="line">    </span><br><span class="line">    id result &#x3D; [self executeQuery:sql withArgumentsInArray:nil orDictionary:nil orVAList:args];</span><br><span class="line">    </span><br><span class="line">    va_end(args);</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>内部调用的是 <code>- executeQuery:withArgumentsInArray:orDictionary:orVAList:</code> 这个方法，把可变参数列表传给VAList。 到最后我们会发现实际上所有的query操作最后都是调用的这个方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line">- (FMResultSet *)executeQuery:(NSString *)sql withArgumentsInArray:(NSArray*)arrayArgs orDictionary:(NSDictionary *)dictionaryArgs orVAList:(va_list)args &#123;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 数据库是否打开</span><br><span class="line">    if (![self databaseExists]) &#123;</span><br><span class="line">        return 0x00;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 数据库是否正在使用</span><br><span class="line">    if (_isExecutingStatement) &#123;</span><br><span class="line">        [self warnInUse];</span><br><span class="line">        return 0x00;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _isExecutingStatement &#x3D; YES;</span><br><span class="line">    </span><br><span class="line">    int rc                  &#x3D; 0x00;</span><br><span class="line">    sqlite3_stmt *pStmt     &#x3D; 0x00;</span><br><span class="line">    FMStatement *statement  &#x3D; 0x00;</span><br><span class="line">    FMResultSet *rs         &#x3D; 0x00;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 是否需要追踪sql执行状态</span><br><span class="line">    if (_traceExecution &amp;&amp; sql) &#123;</span><br><span class="line">        NSLog(@&quot;%@ executeQuery: %@&quot;, self, sql);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 查找缓存</span><br><span class="line">    if (_shouldCacheStatements) &#123;</span><br><span class="line">        statement &#x3D; [self cachedStatementForQuery:sql];</span><br><span class="line">        pStmt &#x3D; statement ? [statement statement] : 0x00;</span><br><span class="line">        &#x2F;&#x2F; reset prepared</span><br><span class="line">        [statement reset];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 若缓存中没有sql对应的prepared语句，使用sqlite3_prepare_v2函数进行预处理</span><br><span class="line">    if (!pStmt) &#123;</span><br><span class="line">        </span><br><span class="line">        rc &#x3D; sqlite3_prepare_v2(_db, [sql UTF8String], -1, &amp;pStmt, 0);</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; 预处理失败</span><br><span class="line">        if (SQLITE_OK !&#x3D; rc) &#123;</span><br><span class="line">            if (_logsErrors) &#123;</span><br><span class="line">                NSLog(@&quot;DB Error: %d \&quot;%@\&quot;&quot;, [self lastErrorCode], [self lastErrorMessage]);</span><br><span class="line">                NSLog(@&quot;DB Query: %@&quot;, sql);</span><br><span class="line">                NSLog(@&quot;DB Path: %@&quot;, _databasePath);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if (_crashOnErrors) &#123;</span><br><span class="line">                NSAssert(false, @&quot;DB Error: %d \&quot;%@\&quot;&quot;, [self lastErrorCode], [self lastErrorMessage]);</span><br><span class="line">                abort();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            sqlite3_finalize(pStmt);</span><br><span class="line">            _isExecutingStatement &#x3D; NO;</span><br><span class="line">            return nil;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    id obj;</span><br><span class="line">    int idx &#x3D; 0;</span><br><span class="line">    &#x2F;&#x2F; 获取pStmt中需要绑定的参数个数</span><br><span class="line">    int queryCount &#x3D; sqlite3_bind_parameter_count(pStmt); &#x2F;&#x2F; pointed out by Dominic Yu (thanks!)</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; If dictionaryArgs is passed in, that means we are using sqlite&#39;s named parameter support</span><br><span class="line">    if (dictionaryArgs) &#123;</span><br><span class="line">        </span><br><span class="line">        for (NSString *dictionaryKey in [dictionaryArgs allKeys]) &#123;</span><br><span class="line">            </span><br><span class="line">            &#x2F;&#x2F; Prefix the key with a colon.</span><br><span class="line">            NSString *parameterName &#x3D; [[NSString alloc] initWithFormat:@&quot;:%@&quot;, dictionaryKey];</span><br><span class="line">            </span><br><span class="line">            if (_traceExecution) &#123;</span><br><span class="line">                NSLog(@&quot;%@ &#x3D; %@&quot;, parameterName, [dictionaryArgs objectForKey:dictionaryKey]);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            &#x2F;&#x2F; Get the index for the parameter name.</span><br><span class="line">            int namedIdx &#x3D; sqlite3_bind_parameter_index(pStmt, [parameterName UTF8String]);</span><br><span class="line">            </span><br><span class="line">            FMDBRelease(parameterName);</span><br><span class="line">            </span><br><span class="line">            if (namedIdx &gt; 0) &#123;</span><br><span class="line">                &#x2F;&#x2F; Standard binding from here.</span><br><span class="line">                [self bindObject:[dictionaryArgs objectForKey:dictionaryKey] toColumn:namedIdx inStatement:pStmt];</span><br><span class="line">                &#x2F;&#x2F; increment the binding count, so our check below works out</span><br><span class="line">                idx++;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                NSLog(@&quot;Could not find index for %@&quot;, dictionaryKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        </span><br><span class="line">        while (idx &lt; queryCount) &#123;</span><br><span class="line">            </span><br><span class="line">            if (arrayArgs &amp;&amp; idx &lt; (int)[arrayArgs count]) &#123;</span><br><span class="line">                obj &#x3D; [arrayArgs objectAtIndex:(NSUInteger)idx];</span><br><span class="line">            &#125;</span><br><span class="line">            else if (args) &#123;</span><br><span class="line">                obj &#x3D; va_arg(args, id);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                &#x2F;&#x2F;We ran out of arguments</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if (_traceExecution) &#123;</span><br><span class="line">                if ([obj isKindOfClass:[NSData class]]) &#123;</span><br><span class="line">                    NSLog(@&quot;data: %ld bytes&quot;, (unsigned long)[(NSData*)obj length]);</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    NSLog(@&quot;obj: %@&quot;, obj);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            idx++;</span><br><span class="line">            </span><br><span class="line">            [self bindObject:obj toColumn:idx inStatement:pStmt];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 若参数个数不对，释放资源 返回</span><br><span class="line">    if (idx !&#x3D; queryCount) &#123;</span><br><span class="line">        NSLog(@&quot;Error: the bind count is not correct for the # of variables (executeQuery)&quot;);</span><br><span class="line">        sqlite3_finalize(pStmt);</span><br><span class="line">        _isExecutingStatement &#x3D; NO;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    FMDBRetain(statement); &#x2F;&#x2F; to balance the release below</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; statement不为空，进行缓存</span><br><span class="line">    if (!statement) &#123;</span><br><span class="line">        statement &#x3D; [[FMStatement alloc] init];</span><br><span class="line">        [statement setStatement:pStmt];</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; 使用sql作为key来缓存statement（即sql对应的prepare语句）</span><br><span class="line">        if (_shouldCacheStatements &amp;&amp; sql) &#123;</span><br><span class="line">            [self setCachedStatement:statement forQuery:sql];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; the statement gets closed in rs&#39;s dealloc or [rs close];</span><br><span class="line">    &#x2F;&#x2F; 创建FMResultSet对象, 拿此对象获取结果集</span><br><span class="line">    rs &#x3D; [FMResultSet resultSetWithStatement:statement usingParentDatabase:self];</span><br><span class="line">    [rs setQuery:sql];</span><br><span class="line">    </span><br><span class="line">    NSValue *openResultSet &#x3D; [NSValue valueWithNonretainedObject:rs];</span><br><span class="line">    [_openResultSets addObject:openResultSet];</span><br><span class="line">    </span><br><span class="line">    [statement setUseCount:[statement useCount] + 1];</span><br><span class="line">    </span><br><span class="line">    FMDBRelease(statement);</span><br><span class="line">    </span><br><span class="line">    _isExecutingStatement &#x3D; NO;</span><br><span class="line">    </span><br><span class="line">    return rs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结这个方法，简单的分为几步来看</p>
<ol>
<li><p>首先会根据sql语句来查找对应的缓存，这个缓存内部存储的是 <code>FMStatement</code>这个对象，如果有缓存，根据缓存找到sql对应的编译对象 <code>sqlite3_stmt</code> </p>
<p>(ps: 每一条sql语句的执行之前，都会将sql编译为对应的sqlite3_stmt对象，也叫做prepared语句对象，prepared语句就像是目标代码一样。由于编译sql比较消耗性能，所以这里进行缓存，下一次可以直接使用编译后的对象)</p>
</li>
<li><p>如果没有缓存，则调用 <code>sqlite3_prepare_v2()</code> 对sql进行预编译，生成sqlite3_stmt对象。<code>sqlite3_prepare_v2()</code>返回SQLITE_OK则代表成功，如果失败的话调用 <code>sqlite3_finalize()</code>释放prepared语句。   </p>
</li>
<li><p>绑定参数。根据arrayArgs、dictionaryArgs、args三个参数来确定绑定参数。</p>
<p>绑定操作执行完成之后，判断绑定参数是否正确，如果有问题，则报错，然后释放prepared语句。</p>
</li>
<li><p>如果经过上述操作之后，基本已经完成了sql的前期工作。 接下来就是对FMStatement进行缓存，以便下一次操作。</p>
</li>
<li><p>缓存完毕之后，创建FMResultSet对象，绑定对应的sql、prepared语句和当前database对象。至此query方式就完毕了。</p>
<p>（FMResultSet对象主要是用来存储查询返回的结果集，我们后面获取返回的数据都是在和FMResultSet打交道）</p>
</li>
</ol>
<p>接下来看另外几个query方法，都是针对上面方法的包装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">– executeQuery:</span><br><span class="line">– executeQueryWithFormat:</span><br><span class="line">– executeQuery:withArgumentsInArray:</span><br><span class="line">– executeQuery:values:error:</span><br><span class="line">– executeQuery:withParameterDictionary:</span><br></pre></td></tr></table></figure>

<p>最后来看一下几种方法的简单使用就可以更好的理解了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 可变参数 executeQuery</span><br><span class="line">    FMResultSet *rs0 &#x3D; [db executeQuery:@&quot;select * from city where name&#x3D;?&quot;, @&quot;北京&quot;];</span><br><span class="line">    while ([rs0 next]) &#123;</span><br><span class="line">        NSLog(@&quot;%@&quot;, [rs0 resultDictionary]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 可以使用oc的格式化进行操作 executeQueryWithFormat</span><br><span class="line">    FMResultSet *rs1 &#x3D; [db executeQueryWithFormat:@&quot;select * from city where name&#x3D;%@&quot;, @&quot;北京&quot;];</span><br><span class="line">    while ([rs1 next]) &#123;</span><br><span class="line">        NSLog(@&quot;%@&quot;, [rs1 resultDictionary]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; array  executeQuery:withArgumentsInArray:</span><br><span class="line">    FMResultSet *rs2 &#x3D; [db executeQuery:@&quot;select * from city where name&#x3D;?&quot; withArgumentsInArray:@[@&quot;北京&quot;]];</span><br><span class="line">    while ([rs2 next]) &#123;</span><br><span class="line">        NSLog(@&quot;%@&quot;, [rs2 resultDictionary]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; dic  executeQuery:withParameterDictionary:</span><br><span class="line">    NSMutableDictionary *dic &#x3D; [NSMutableDictionary dictionary];</span><br><span class="line">    dic[@&quot;name&quot;] &#x3D; @&quot;北京&quot;;</span><br><span class="line">    FMResultSet *rs3 &#x3D; [db executeQuery:@&quot;select * from city where name&#x3D;:name&quot; 	withParameterDictionary:dic];</span><br><span class="line">    while ([rs3 next]) &#123;</span><br><span class="line">        NSLog(@&quot;%@&quot;, [rs3 resultDictionary]);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-update-插入、更新、删除"><a href="#3-update-插入、更新、删除" class="headerlink" title="3. update(插入、更新、删除)"></a>3. update(插入、更新、删除)</h3><p>上面第二部分的query主要是针对select方法。 如果我们要进行update、insert into、delete操作，则要调用 <code>executeUpdate:</code> 方法，换句话说，除了select语句，其他的都调用 <code>executeUpdate:</code> 方法 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BOOL rs &#x3D; [db executeUpdate:@&quot;insert into city (id, code, name, level, parentCode, first_char) values (?, ?, ?, ?, ?, ?)&quot; , @1, @(1), @&quot;测试城市&quot;, @3, @0, @&quot;c&quot;];</span><br></pre></td></tr></table></figure>

<p>这里例子是向city表内插入一行数据，调用的 <code>executeUpdate:</code> 方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)executeUpdate:(NSString*)sql, ... &#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    va_start(args, sql);</span><br><span class="line">    </span><br><span class="line">    BOOL result &#x3D; [self executeUpdate:sql error:nil withArgumentsInArray:nil orDictionary:nil orVAList:args];</span><br><span class="line">    </span><br><span class="line">    va_end(args);</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于不是查询语句，不需要返回数据。所以此方法的返回值是BOOL，只是告诉调用方成功与否。</p>
<p>可以看到这个方法内部调用的是 <code>- executeUpdate:error: withArgumentsInArray:orDictionary:orVAList:</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)executeUpdate:(NSString*)sql error:(NSError * _Nullable __autoreleasing *)outErr withArgumentsInArray:(NSArray*)arrayArgs orDictionary:(NSDictionary *)dictionaryArgs orVAList:(va_list)args &#123;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 检查db打开状态</span><br><span class="line">    if (![self databaseExists]) &#123;</span><br><span class="line">        return NO;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 是否正在执行中</span><br><span class="line">    if (_isExecutingStatement) &#123;</span><br><span class="line">        [self warnInUse];</span><br><span class="line">        return NO;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _isExecutingStatement &#x3D; YES;</span><br><span class="line">    </span><br><span class="line">    int rc                   &#x3D; 0x00;</span><br><span class="line">    sqlite3_stmt *pStmt      &#x3D; 0x00;  &#x2F;&#x2F; 编译好的sql准备语句的指针</span><br><span class="line">    FMStatement *cachedStmt  &#x3D; 0x00;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 是否跟踪sql执行状态</span><br><span class="line">    if (_traceExecution &amp;&amp; sql) &#123;</span><br><span class="line">        NSLog(@&quot;%@ executeUpdate: %@&quot;, self, sql);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 缓存</span><br><span class="line">    if (_shouldCacheStatements) &#123;</span><br><span class="line">        cachedStmt &#x3D; [self cachedStatementForQuery:sql];</span><br><span class="line">        pStmt &#x3D; cachedStmt ? [cachedStmt statement] : 0x00;</span><br><span class="line">        [cachedStmt reset];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 没有缓存指针，创建</span><br><span class="line">    if (!pStmt) &#123;</span><br><span class="line">        &#x2F;&#x2F; 预编译 将sql命令转为成一个准备对象，并返回这个对象的指针 &amp;pStmt</span><br><span class="line">        rc &#x3D; sqlite3_prepare_v2(_db, [sql UTF8String], -1, &amp;pStmt, 0);</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; 不成功，则执行一系列日志打印操作，释放指针</span><br><span class="line">        if (SQLITE_OK !&#x3D; rc) &#123;</span><br><span class="line">            if (_logsErrors) &#123;</span><br><span class="line">                NSLog(@&quot;DB Error: %d \&quot;%@\&quot;&quot;, [self lastErrorCode], [self lastErrorMessage]);</span><br><span class="line">                NSLog(@&quot;DB Query: %@&quot;, sql);</span><br><span class="line">                NSLog(@&quot;DB Path: %@&quot;, _databasePath);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if (_crashOnErrors) &#123;</span><br><span class="line">                NSAssert(false, @&quot;DB Error: %d \&quot;%@\&quot;&quot;, [self lastErrorCode], [self lastErrorMessage]);</span><br><span class="line">                abort();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if (outErr) &#123;</span><br><span class="line">                *outErr &#x3D; [self errorWithMessage:[NSString stringWithUTF8String:sqlite3_errmsg(_db)]];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            &#x2F;&#x2F; 销毁sqlite3_prepare_v2的准备语句，防止内存泄露</span><br><span class="line">            sqlite3_finalize(pStmt);</span><br><span class="line">            </span><br><span class="line">            _isExecutingStatement &#x3D; NO;</span><br><span class="line">            return NO;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    id obj;</span><br><span class="line">    int idx &#x3D; 0;</span><br><span class="line">    int queryCount &#x3D; sqlite3_bind_parameter_count(pStmt);</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; If dictionaryArgs is passed in, that means we are using sqlite&#39;s named parameter support</span><br><span class="line">    if (dictionaryArgs) &#123;</span><br><span class="line">        </span><br><span class="line">        for (NSString *dictionaryKey in [dictionaryArgs allKeys]) &#123;</span><br><span class="line">            </span><br><span class="line">            &#x2F;&#x2F; Prefix the key with a colon.</span><br><span class="line">            NSString *parameterName &#x3D; [[NSString alloc] initWithFormat:@&quot;:%@&quot;, dictionaryKey];</span><br><span class="line">            </span><br><span class="line">            if (_traceExecution) &#123;</span><br><span class="line">                NSLog(@&quot;%@ &#x3D; %@&quot;, parameterName, [dictionaryArgs objectForKey:dictionaryKey]);</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; Get the index for the parameter name.</span><br><span class="line">            &#x2F;&#x2F; sqlite3_bind_parameter_inde() 根据name找出index</span><br><span class="line">            int namedIdx &#x3D; sqlite3_bind_parameter_index(pStmt, [parameterName UTF8String]);</span><br><span class="line">            </span><br><span class="line">            FMDBRelease(parameterName);</span><br><span class="line">            </span><br><span class="line">            &#x2F;&#x2F; 若找出索引，拿index和值绑定</span><br><span class="line">            if (namedIdx &gt; 0) &#123;</span><br><span class="line">                &#x2F;&#x2F; Standard binding from here.</span><br><span class="line">                [self bindObject:[dictionaryArgs objectForKey:dictionaryKey] toColumn:namedIdx inStatement:pStmt];</span><br><span class="line">                </span><br><span class="line">                &#x2F;&#x2F; increment the binding count, so our check below works out</span><br><span class="line">                idx++;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                NSString *message &#x3D; [NSString stringWithFormat:@&quot;Could not find index for %@&quot;, dictionaryKey];</span><br><span class="line">                </span><br><span class="line">                if (_logsErrors) &#123;</span><br><span class="line">                    NSLog(@&quot;%@&quot;, message);</span><br><span class="line">                &#125;</span><br><span class="line">                if (outErr) &#123;</span><br><span class="line">                    *outErr &#x3D; [self errorWithMessage:message];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        </span><br><span class="line">        while (idx &lt; queryCount) &#123;</span><br><span class="line">            </span><br><span class="line">            &#x2F;&#x2F; 如果是数组，分别取出每一个元素绑定</span><br><span class="line">            if (arrayArgs &amp;&amp; idx &lt; (int)[arrayArgs count]) &#123;</span><br><span class="line">                obj &#x3D; [arrayArgs objectAtIndex:(NSUInteger)idx];</span><br><span class="line">            &#125;</span><br><span class="line">            else if (args) &#123; &#x2F;&#x2F; 可变列表取出每一个绑定</span><br><span class="line">                obj &#x3D; va_arg(args, id);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                &#x2F;&#x2F;We ran out of arguments</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if (_traceExecution) &#123;</span><br><span class="line">                if ([obj isKindOfClass:[NSData class]]) &#123;</span><br><span class="line">                    NSLog(@&quot;data: %ld bytes&quot;, (unsigned long)[(NSData*)obj length]);</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    NSLog(@&quot;obj: %@&quot;, obj);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            idx++;</span><br><span class="line">            </span><br><span class="line">            &#x2F;&#x2F; 绑定参数</span><br><span class="line">            [self bindObject:obj toColumn:idx inStatement:pStmt];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 实际绑定的参数个数 !&#x3D; 实际参数个数</span><br><span class="line">    if (idx !&#x3D; queryCount) &#123;</span><br><span class="line">        NSString *message &#x3D; [NSString stringWithFormat:@&quot;Error: the bind count (%d) is not correct for the # of variables in the query (%d) (%@) (executeUpdate)&quot;, idx, queryCount, sql];</span><br><span class="line">        if (_logsErrors) &#123;</span><br><span class="line">            NSLog(@&quot;%@&quot;, message);</span><br><span class="line">        &#125;</span><br><span class="line">        if (outErr) &#123;</span><br><span class="line">            *outErr &#x3D; [self errorWithMessage:message];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        sqlite3_finalize(pStmt);</span><br><span class="line">        _isExecutingStatement &#x3D; NO;</span><br><span class="line">        return NO;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;* Call sqlite3_step() to run the virtual machine. Since the SQL being</span><br><span class="line">     ** executed is not a SELECT statement, we assume no data will be returned.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 预编译之后就可以通过setup执行</span><br><span class="line">    rc      &#x3D; sqlite3_step(pStmt);</span><br><span class="line">    </span><br><span class="line">    if (SQLITE_DONE &#x3D;&#x3D; rc) &#123; &#x2F;&#x2F; 执行完成</span><br><span class="line">        &#x2F;&#x2F; all is well, let&#39;s return.</span><br><span class="line">    &#125;</span><br><span class="line">    else if (SQLITE_INTERRUPT &#x3D;&#x3D; rc) &#123; &#x2F;&#x2F; 执行中断</span><br><span class="line">        if (_logsErrors) &#123;</span><br><span class="line">            NSLog(@&quot;Error calling sqlite3_step. Query was interrupted (%d: %s) SQLITE_INTERRUPT&quot;, rc, sqlite3_errmsg(_db));</span><br><span class="line">            NSLog(@&quot;DB Query: %@&quot;, sql);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (rc &#x3D;&#x3D; SQLITE_ROW) &#123; &#x2F;&#x2F; 报错，说明这是一条select语句</span><br><span class="line">        NSString *message &#x3D; [NSString stringWithFormat:@&quot;A executeUpdate is being called with a query string &#39;%@&#39;&quot;, sql];</span><br><span class="line">        if (_logsErrors) &#123;</span><br><span class="line">            NSLog(@&quot;%@&quot;, message);</span><br><span class="line">            NSLog(@&quot;DB Query: %@&quot;, sql);</span><br><span class="line">        &#125;</span><br><span class="line">        if (outErr) &#123;</span><br><span class="line">            *outErr &#x3D; [self errorWithMessage:message];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123; &#x2F;&#x2F; 其他失败情况</span><br><span class="line">        if (outErr) &#123;</span><br><span class="line">            *outErr &#x3D; [self errorWithMessage:[NSString stringWithUTF8String:sqlite3_errmsg(_db)]];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (SQLITE_ERROR &#x3D;&#x3D; rc) &#123;</span><br><span class="line">            if (_logsErrors) &#123;</span><br><span class="line">                NSLog(@&quot;Error calling sqlite3_step (%d: %s) SQLITE_ERROR&quot;, rc, sqlite3_errmsg(_db));</span><br><span class="line">                NSLog(@&quot;DB Query: %@&quot;, sql);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (SQLITE_MISUSE &#x3D;&#x3D; rc) &#123;</span><br><span class="line">            &#x2F;&#x2F; uh oh.</span><br><span class="line">            if (_logsErrors) &#123;</span><br><span class="line">                NSLog(@&quot;Error calling sqlite3_step (%d: %s) SQLITE_MISUSE&quot;, rc, sqlite3_errmsg(_db));</span><br><span class="line">                NSLog(@&quot;DB Query: %@&quot;, sql);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            &#x2F;&#x2F; wtf?</span><br><span class="line">            if (_logsErrors) &#123;</span><br><span class="line">                NSLog(@&quot;Unknown error calling sqlite3_step (%d: %s) eu&quot;, rc, sqlite3_errmsg(_db));</span><br><span class="line">                NSLog(@&quot;DB Query: %@&quot;, sql);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 需要缓存且未被缓存，则执行缓存</span><br><span class="line">    if (_shouldCacheStatements &amp;&amp; !cachedStmt) &#123;</span><br><span class="line">        cachedStmt &#x3D; [[FMStatement alloc] init];</span><br><span class="line">        </span><br><span class="line">        [cachedStmt setStatement:pStmt];</span><br><span class="line">        </span><br><span class="line">        [self setCachedStatement:cachedStmt forQuery:sql];</span><br><span class="line">        </span><br><span class="line">        FMDBRelease(cachedStmt);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    int closeErrorCode;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 被缓存之后，恢复pStmt对象</span><br><span class="line">    if (cachedStmt) &#123;</span><br><span class="line">        [cachedStmt setUseCount:[cachedStmt useCount] + 1];</span><br><span class="line">        closeErrorCode &#x3D; sqlite3_reset(pStmt);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        &#x2F;* Finalize the virtual machine. This releases all memory and other</span><br><span class="line">         ** resources allocated by the sqlite3_prepare() call above.</span><br><span class="line">         *&#x2F;</span><br><span class="line">        &#x2F;&#x2F; 释放pStmt</span><br><span class="line">        closeErrorCode &#x3D; sqlite3_finalize(pStmt);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (closeErrorCode !&#x3D; SQLITE_OK) &#123;</span><br><span class="line">        if (_logsErrors) &#123;</span><br><span class="line">            NSLog(@&quot;Unknown error finalizing or resetting statement (%d: %s)&quot;, closeErrorCode, sqlite3_errmsg(_db));</span><br><span class="line">            NSLog(@&quot;DB Query: %@&quot;, sql);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _isExecutingStatement &#x3D; NO;</span><br><span class="line">    return (rc &#x3D;&#x3D; SQLITE_DONE || rc &#x3D;&#x3D; SQLITE_OK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此方法是query的方法调用逻辑大体是一样的，也大致分为了几步：</p>
<ol>
<li><p>查找缓存FMStatement对象，给prepared语句赋值</p>
</li>
<li><p>若prepared语句对象为空，则调用 <code>sqlite3_prepare_v2()</code> 进行编译，获取prepared语句对象（sqlite3_stmt）</p>
</li>
<li><p>根据参数列表绑定sql参数</p>
</li>
<li><p>这一步跟query就不一样了。由于这里是立马就要执行，所以调用了 <code>sqlite3_step()</code> 方法</p>
<p>(sqlite3_step: 在生成prepared语句之后，不要调用此函数一次或多次以计算sql语句，返回 <code>SQLITE_DONE</code> 表示语句已经完成执行，返回 <code>SQLITE_ROW</code> 代表这是一条select语句，还会有下一条结果)</p>
</li>
<li><p>执行完step之后就表示操作已经完成了，这时候跟query一样，进行缓存</p>
</li>
<li><p>如果step之后返回值为 <code>SQLITE_DONE</code> || <code>SQLITE_OK</code> 则此方法返回YES，反之为NO，执行失败。</p>
</li>
</ol>
<p>接下来看另外几个update方法，也是根据上面的方法进行的包装方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">– executeUpdate:</span><br><span class="line">– executeUpdateWithFormat:</span><br><span class="line">– executeUpdate:withArgumentsInArray:</span><br><span class="line">– executeUpdate:values:error:</span><br><span class="line">– executeUpdate:withParameterDictionary:</span><br><span class="line">– executeUpdate:withVAList:</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[db executeUpdate:@&quot;insert into city (id, code, name, level, parentCode, first_char) values (?, ?, ?, ?, ?, ?)&quot; , @1, @(1), @&quot;测试城市&quot;, @3, @0, @&quot;c&quot;];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NSMutableDictionary *dictionaryArgs &#x3D; [NSMutableDictionary dictionary];</span><br><span class="line">dictionaryArgs[@&quot;id&quot;] &#x3D; @1;</span><br><span class="line">dictionaryArgs[@&quot;code&quot;] &#x3D; @1;</span><br><span class="line">dictionaryArgs[@&quot;name&quot;] &#x3D; @&quot;哈哈哈&quot;;</span><br><span class="line">dictionaryArgs[@&quot;level&quot;] &#x3D; @3;</span><br><span class="line">dictionaryArgs[@&quot;parentCode&quot;] &#x3D; @0;</span><br><span class="line">dictionaryArgs[@&quot;first_char&quot;] &#x3D; @&quot;h&quot;;</span><br><span class="line"></span><br><span class="line">[db executeUpdate:@&quot;insert into city (id, code, name, level, parentCode, first_char) values (:id, :code, :name, :level, :parentCode, :first_char)&quot; withParameterDictionary:dictionaryArgs];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NSArray *ary &#x3D; @[@1, @(1), @&quot;测试城市&quot;, @3, @0, @&quot;c&quot;];</span><br><span class="line">[db executeUpdate:@&quot;insert into city (id, code, name, level, parentCode, first_char) values (?, ?, ?, ?, ?, ?)&quot; withArgumentsInArray:ary];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BOOL success &#x3D; [db executeUpdateWithFormat:@&quot;insert into city (id, code, name, level, parentCode, first_char) values (%d, %d, %@, %d, %d, %@)&quot;, 1, 1, @&quot;哈哈哈&quot;, 2, 0, @&quot;h&quot;];</span><br></pre></td></tr></table></figure>



<p>还有一个方法需要单独看一下</p>
<p><code>- executeStatements:</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)executeStatements:(NSString *)sql &#123;</span><br><span class="line">    return [self executeStatements:sql withResultBlock:nil];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;&#x2F; 可以执行多条sql语句，内部是调用sqlite3_exec()</span><br><span class="line">- (BOOL)executeStatements:(NSString *)sql withResultBlock:(__attribute__((noescape)) FMDBExecuteStatementsCallbackBlock)block &#123;</span><br><span class="line">    </span><br><span class="line">    int rc;</span><br><span class="line">    char *errmsg &#x3D; nil;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 返回结果在 FMDBExecuteBulkSQLCallback 函数内部处理</span><br><span class="line">    rc &#x3D; sqlite3_exec([self sqliteHandle], [sql UTF8String], block ? FMDBExecuteBulkSQLCallback : nil, (__bridge void *)(block), &amp;errmsg);</span><br><span class="line">    </span><br><span class="line">    if (errmsg &amp;&amp; [self logsErrors]) &#123;</span><br><span class="line">        NSLog(@&quot;Error inserting batch: %s&quot;, errmsg);</span><br><span class="line">    &#125;</span><br><span class="line">    if (errmsg) &#123;</span><br><span class="line">        sqlite3_free(errmsg);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return (rc &#x3D;&#x3D; SQLITE_OK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法是用来执行多条sql语句的，内部调用的是 <code>sqlite3_exec()</code>  函数。</p>
<p><code>sqlite3_exec</code>： 是prepare、step、finalize几个方法的包装，用来运行多个sql语句，无需使用大量c代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SQLITE_API <span class="keyword">int</span> <span class="title">sqlite3_exec</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  sqlite3*,                                  <span class="comment">/* An open database */</span></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">const</span> <span class="keyword">char</span> *sql,                           <span class="comment">/* SQL to be evaluated */</span></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">int</span> (*callback)(<span class="keyword">void</span>*,<span class="keyword">int</span>,<span class="keyword">char</span>**,<span class="keyword">char</span>**),  <span class="comment">/* Callback function */</span></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">void</span> *,                                    <span class="comment">/* 1st argument to callback */</span></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">char</span> **errmsg                              <span class="comment">/* Error msg written here */</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>第三个参数是执行结果的回调</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">int FMDBExecuteBulkSQLCallback(void *theBlockAsVoid, int columns, char **values, char **names); &#x2F;&#x2F; shhh clang.</span><br><span class="line">int FMDBExecuteBulkSQLCallback(void *theBlockAsVoid, int columns, char **values, char **names) &#123;</span><br><span class="line">    </span><br><span class="line">    if (!theBlockAsVoid) &#123;</span><br><span class="line">        return SQLITE_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    int (^execCallbackBlock)(NSDictionary *resultsDictionary) &#x3D; (__bridge int (^)(NSDictionary *__strong))(theBlockAsVoid);</span><br><span class="line">    </span><br><span class="line">    NSMutableDictionary *dictionary &#x3D; [NSMutableDictionary dictionaryWithCapacity:(NSUInteger)columns];</span><br><span class="line">    </span><br><span class="line">    for (NSInteger i &#x3D; 0; i &lt; columns; i++) &#123;</span><br><span class="line">        NSString *key &#x3D; [NSString stringWithUTF8String:names[i]];</span><br><span class="line">        id value &#x3D; values[i] ? [NSString stringWithUTF8String:values[i]] : [NSNull null];</span><br><span class="line">        value &#x3D; value ? value : [NSNull null];</span><br><span class="line">        [dictionary setObject:value forKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return execCallbackBlock(dictionary);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>回调中第二个参数columns代表返回结果的列数</p>
<p>第三个参数<code>**values</code> 指向字段值的指针数组，是通过<code>sqlite3_column_text()</code>获取的</p>
<p>第四个参数<code>**names</code> 指向字段名称的指针数组，是通过<code>sqlite3_column_name()</code> 获取的</p>
<h3 id="4-Transaction-事务"><a href="#4-Transaction-事务" class="headerlink" title="4. Transaction (事务)"></a>4. Transaction (事务)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)rollback &#123;</span><br><span class="line">    BOOL b &#x3D; [self executeUpdate:@&quot;rollback transaction&quot;];</span><br><span class="line">    </span><br><span class="line">    if (b) &#123;</span><br><span class="line">        _isInTransaction &#x3D; NO;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)commit &#123;</span><br><span class="line">    BOOL b &#x3D;  [self executeUpdate:@&quot;commit transaction&quot;];</span><br><span class="line">    </span><br><span class="line">    if (b) &#123;</span><br><span class="line">        _isInTransaction &#x3D; NO;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)beginTransaction &#123;</span><br><span class="line">    </span><br><span class="line">    BOOL b &#x3D; [self executeUpdate:@&quot;begin exclusive transaction&quot;];</span><br><span class="line">    if (b) &#123;</span><br><span class="line">        _isInTransaction &#x3D; YES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的事务处理比较简单，主要就是调用executeUpdate方法执行事务sql。 </p>
<h2 id="FMStatement"><a href="#FMStatement" class="headerlink" title="FMStatement"></a>FMStatement</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;** Usage count *&#x2F;</span><br><span class="line"></span><br><span class="line">@property (atomic, assign) long useCount;</span><br><span class="line"></span><br><span class="line">&#x2F;** SQL statement *&#x2F;</span><br><span class="line"></span><br><span class="line">@property (atomic, retain) NSString *query;</span><br><span class="line"></span><br><span class="line">&#x2F;** SQLite sqlite3_stmt</span><br><span class="line"> </span><br><span class="line"> @see [&#96;sqlite3_stmt&#96;](http:&#x2F;&#x2F;www.sqlite.org&#x2F;c3ref&#x2F;stmt.html)</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">@property (atomic, assign) void *statement;</span><br><span class="line"></span><br><span class="line">&#x2F;** Indication of whether the statement is in use *&#x2F;</span><br><span class="line"></span><br><span class="line">@property (atomic, assign) BOOL inUse;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;&#x2F;----------------------------</span><br><span class="line">&#x2F;&#x2F;&#x2F; @name Closing and Resetting</span><br><span class="line">&#x2F;&#x2F;&#x2F;----------------------------</span><br><span class="line"></span><br><span class="line">&#x2F;** Close statement *&#x2F;</span><br><span class="line"></span><br><span class="line">- (void)close;</span><br><span class="line"></span><br><span class="line">&#x2F;** Reset statement *&#x2F;</span><br><span class="line"></span><br><span class="line">- (void)reset;</span><br></pre></td></tr></table></figure>

<p>主要是针对sqlite3_stmt的包装类，FMDatabase中缓存的类就是此类</p>
<h3 id="close-1"><a href="#close-1" class="headerlink" title="close"></a>close</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;&#x2F; 释放prepared语句资源，避免内存泄露</span><br><span class="line">- (void)close &#123;</span><br><span class="line">    if (_statement) &#123;</span><br><span class="line">        sqlite3_finalize(_statement);</span><br><span class="line">        _statement &#x3D; 0x00;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _inUse &#x3D; NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>close释放prepared语句，使用sqlite3_finalize()释放资源</p>
<h3 id="reset"><a href="#reset" class="headerlink" title="reset"></a>reset</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;&#x2F; 重置prepared语句</span><br><span class="line">- (void)reset &#123;</span><br><span class="line">    if (_statement) &#123;</span><br><span class="line">        sqlite3_reset(_statement);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _inUse &#x3D; NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>reset重置prepared语句，回到编译之后的状态，可重新绑定参数使用</p>
<h2 id="FMResultSet"><a href="#FMResultSet" class="headerlink" title="FMResultSet"></a>FMResultSet</h2><p>表示在FMDatabase上执行查询的结果</p>
<h3 id="next"><a href="#next" class="headerlink" title="next"></a>next</h3><p>主要方法就是next</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)next &#123;</span><br><span class="line">    return [self nextWithError:nil];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line"> * 调用sqlite3_step获取一次结果，</span><br><span class="line"> 如果结果是 SQLITE_DONE 说明获取完成</span><br><span class="line"> 如果结果是 SQLITE_ROW 说明是查询数据，一行一行返回，还有下一次结果</span><br><span class="line"> *&#x2F;</span><br><span class="line">- (BOOL)nextWithError:(NSError * _Nullable __autoreleasing *)outErr &#123;</span><br><span class="line">    </span><br><span class="line">    int rc &#x3D; sqlite3_step([_statement statement]);</span><br><span class="line">    </span><br><span class="line">    if (SQLITE_BUSY &#x3D;&#x3D; rc || SQLITE_LOCKED &#x3D;&#x3D; rc) &#123;</span><br><span class="line">        NSLog(@&quot;%s:%d Database busy (%@)&quot;, __FUNCTION__, __LINE__, [_parentDB databasePath]);</span><br><span class="line">        NSLog(@&quot;Database busy&quot;);</span><br><span class="line">        if (outErr) &#123;</span><br><span class="line">            *outErr &#x3D; [_parentDB lastError];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (SQLITE_DONE &#x3D;&#x3D; rc || SQLITE_ROW &#x3D;&#x3D; rc) &#123;</span><br><span class="line">        &#x2F;&#x2F; all is well, let&#39;s return.</span><br><span class="line">    &#125;</span><br><span class="line">    else if (SQLITE_ERROR &#x3D;&#x3D; rc) &#123;</span><br><span class="line">        NSLog(@&quot;Error calling sqlite3_step (%d: %s) rs&quot;, rc, sqlite3_errmsg([_parentDB sqliteHandle]));</span><br><span class="line">        if (outErr) &#123;</span><br><span class="line">            *outErr &#x3D; [_parentDB lastError];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (SQLITE_MISUSE &#x3D;&#x3D; rc) &#123;</span><br><span class="line">        &#x2F;&#x2F; uh oh.</span><br><span class="line">        NSLog(@&quot;Error calling sqlite3_step (%d: %s) rs&quot;, rc, sqlite3_errmsg([_parentDB sqliteHandle]));</span><br><span class="line">        if (outErr) &#123;</span><br><span class="line">            if (_parentDB) &#123;</span><br><span class="line">                *outErr &#x3D; [_parentDB lastError];</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                &#x2F;&#x2F; If &#39;next&#39; or &#39;nextWithError&#39; is called after the result set is closed,</span><br><span class="line">                &#x2F;&#x2F; we need to return the appropriate error.</span><br><span class="line">                NSDictionary* errorMessage &#x3D; [NSDictionary dictionaryWithObject:@&quot;parentDB does not exist&quot; forKey:NSLocalizedDescriptionKey];</span><br><span class="line">                *outErr &#x3D; [NSError errorWithDomain:@&quot;FMDatabase&quot; code:SQLITE_MISUSE userInfo:errorMessage];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        &#x2F;&#x2F; wtf?</span><br><span class="line">        NSLog(@&quot;Unknown error calling sqlite3_step (%d: %s) rs&quot;, rc, sqlite3_errmsg([_parentDB sqliteHandle]));</span><br><span class="line">        if (outErr) &#123;</span><br><span class="line">            *outErr &#x3D; [_parentDB lastError];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    if (rc !&#x3D; SQLITE_ROW) &#123;</span><br><span class="line">        [self close];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return (rc &#x3D;&#x3D; SQLITE_ROW);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用于执行查询操作之后，调用next获取数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FMResultSet *rs &#x3D; [db executeQuery:@&quot;select * from city&quot;];</span><br><span class="line">while ([rs next]) &#123;</span><br><span class="line">    NSLog(@&quot;%@&quot;, [rs resultDictionary]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每调一次next成功之后，就可以用rs获取数据，有很多种方式来获取数据</p>
<h3 id="resultDictionary"><a href="#resultDictionary" class="headerlink" title="resultDictionary"></a>resultDictionary</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;&#x2F; 结果转换为dictionary</span><br><span class="line">- (NSDictionary*)resultDictionary &#123;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; sqlite3_data_count 返回当前正在执行的sql的列数，没有结果则返回0</span><br><span class="line">    NSUInteger num_cols &#x3D; (NSUInteger)sqlite3_data_count([_statement statement]);</span><br><span class="line">    </span><br><span class="line">    if (num_cols &gt; 0) &#123;</span><br><span class="line">        &#x2F;&#x2F; 根据列数创建字典</span><br><span class="line">        NSMutableDictionary *dict &#x3D; [NSMutableDictionary dictionaryWithCapacity:num_cols];</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; sqlite3_column_count 返回所有列数，跟sql执行状态没关系</span><br><span class="line">        int columnCount &#x3D; sqlite3_column_count([_statement statement]);</span><br><span class="line">        </span><br><span class="line">        int columnIdx &#x3D; 0;</span><br><span class="line">        for (columnIdx &#x3D; 0; columnIdx &lt; columnCount; columnIdx++) &#123;</span><br><span class="line">            &#x2F;&#x2F; 获取列名称</span><br><span class="line">            NSString *columnName &#x3D; [NSString stringWithUTF8String:sqlite3_column_name([_statement statement], columnIdx)];</span><br><span class="line">            &#x2F;&#x2F; 获取value</span><br><span class="line">            id objectValue &#x3D; [self objectForColumnIndex:columnIdx];</span><br><span class="line">            [dict setObject:objectValue forKey:columnName];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return dict;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        NSLog(@&quot;Warning: There seem to be no columns in this set.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>遍历所有行，然后获取列名和值，包装成为一个dictionary返回</p>
<h3 id="xxxForColumn"><a href="#xxxForColumn" class="headerlink" title="xxxForColumn:"></a>xxxForColumn:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">– intForColumn:</span><br><span class="line">– longForColumn:</span><br><span class="line">– longLongIntForColumn:</span><br><span class="line">– unsignedLongLongIntForColumn:</span><br><span class="line">– boolForColumn:</span><br><span class="line">– doubleForColumn:</span><br><span class="line">– stringForColumn:</span><br><span class="line">– dateForColumn:</span><br><span class="line">– dataForColumn:</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>这一系列方法是根据列名称获取结果值，但实际内部是把列名转换为index，然后再获取值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">- (int)columnIndexForName:(NSString*)columnName &#123;</span><br><span class="line">    columnName &#x3D; [columnName lowercaseString];</span><br><span class="line">    </span><br><span class="line">    NSNumber *n &#x3D; [[self columnNameToIndexMap] objectForKey:columnName];</span><br><span class="line">    </span><br><span class="line">    if (n !&#x3D; nil) &#123;</span><br><span class="line">        return [n intValue];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    NSLog(@&quot;Warning: I could not find the column named &#39;%@&#39;.&quot;, columnName);</span><br><span class="line">    </span><br><span class="line">    return -1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSMutableDictionary *)columnNameToIndexMap &#123;</span><br><span class="line">    if (!_columnNameToIndexMap) &#123;</span><br><span class="line">        int columnCount &#x3D; sqlite3_column_count([_statement statement]);</span><br><span class="line">        _columnNameToIndexMap &#x3D; [[NSMutableDictionary alloc] initWithCapacity:(NSUInteger)columnCount];</span><br><span class="line">        int columnIdx &#x3D; 0;</span><br><span class="line">        for (columnIdx &#x3D; 0; columnIdx &lt; columnCount; columnIdx++) &#123;</span><br><span class="line">            [_columnNameToIndexMap setObject:[NSNumber numberWithInt:columnIdx]</span><br><span class="line">                                      forKey:[[NSString stringWithUTF8String:sqlite3_column_name([_statement statement], columnIdx)] lowercaseString]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return _columnNameToIndexMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="xxxForColumnIndex"><a href="#xxxForColumnIndex" class="headerlink" title="xxxForColumnIndex:"></a>xxxForColumnIndex:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">– intForColumnIndex:</span><br><span class="line">– longForColumnIndex:</span><br><span class="line">– longLongIntForColumnIndex:</span><br><span class="line">– unsignedLongLongIntForColumnIndex:</span><br><span class="line">– boolForColumnIndex:</span><br><span class="line">– doubleForColumnIndex:</span><br><span class="line">– stringForColumnIndex:</span><br><span class="line">– dateForColumnIndex:</span><br><span class="line">– dataForColumnIndex:</span><br></pre></td></tr></table></figure>

<p>通过index获取对应的值。内部调用的是 <code>sqlite3_column_xxx()</code> 方法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SQLITE_API <span class="keyword">const</span> <span class="keyword">void</span> *<span class="title">sqlite3_column_blob</span><span class="params">(sqlite3_stmt*, <span class="keyword">int</span> iCol)</span></span>;</span><br><span class="line"><span class="function">SQLITE_API <span class="keyword">double</span> <span class="title">sqlite3_column_double</span><span class="params">(sqlite3_stmt*, <span class="keyword">int</span> iCol)</span></span>;</span><br><span class="line"><span class="function">SQLITE_API <span class="keyword">int</span> <span class="title">sqlite3_column_int</span><span class="params">(sqlite3_stmt*, <span class="keyword">int</span> iCol)</span></span>;</span><br><span class="line"><span class="function">SQLITE_API sqlite3_int64 <span class="title">sqlite3_column_int64</span><span class="params">(sqlite3_stmt*, <span class="keyword">int</span> iCol)</span></span>;</span><br><span class="line"><span class="function">SQLITE_API <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="title">sqlite3_column_text</span><span class="params">(sqlite3_stmt*, <span class="keyword">int</span> iCol)</span></span>;</span><br><span class="line"><span class="function">SQLITE_API <span class="keyword">const</span> <span class="keyword">void</span> *<span class="title">sqlite3_column_text16</span><span class="params">(sqlite3_stmt*, <span class="keyword">int</span> iCol)</span></span>;</span><br><span class="line"><span class="function">SQLITE_API sqlite3_value *<span class="title">sqlite3_column_value</span><span class="params">(sqlite3_stmt*, <span class="keyword">int</span> iCol)</span></span>;</span><br><span class="line"><span class="function">SQLITE_API <span class="keyword">int</span> <span class="title">sqlite3_column_bytes</span><span class="params">(sqlite3_stmt*, <span class="keyword">int</span> iCol)</span></span>;</span><br><span class="line"><span class="function">SQLITE_API <span class="keyword">int</span> <span class="title">sqlite3_column_bytes16</span><span class="params">(sqlite3_stmt*, <span class="keyword">int</span> iCol)</span></span>;</span><br><span class="line"><span class="function">SQLITE_API <span class="keyword">int</span> <span class="title">sqlite3_column_type</span><span class="params">(sqlite3_stmt*, <span class="keyword">int</span> iCol)</span></span>;</span><br></pre></td></tr></table></figure>

<p>第一个参数就是prepared对象</p>
<p>第二个参数是index，最左边为0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sqlite3_column_blob	→	BLOB result</span><br><span class="line">sqlite3_column_double	→	REAL result</span><br><span class="line">sqlite3_column_int	→	32-bit INTEGER result</span><br><span class="line">sqlite3_column_int64	→	64-bit INTEGER result</span><br><span class="line">sqlite3_column_text	→	UTF-8 TEXT result</span><br><span class="line">sqlite3_column_text16	→	UTF-16 TEXT result</span><br><span class="line">sqlite3_column_value	→	The result as an unprotected sqlite3_value object.</span><br><span class="line"> 	 	 </span><br><span class="line">sqlite3_column_bytes	→	Size of a BLOB or a UTF-8 TEXT result in bytes</span><br><span class="line">sqlite3_column_bytes16  	→  	Size of UTF-16 TEXT in bytes</span><br><span class="line">sqlite3_column_type	→	Default datatype of the result</span><br></pre></td></tr></table></figure>

<p>上图为转换的结果</p>
<h2 id="FMDatabaseQueue"><a href="#FMDatabaseQueue" class="headerlink" title="FMDatabaseQueue"></a>FMDatabaseQueue</h2><p>如果需要在多线程中执行操作，就需要使用FMDatabaseQueue，实际项目中建议都使用此类，它是线程安全的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">FMDatabaseQueue *dbQueue &#x3D; [FMDatabaseQueue databaseQueueWithPath:[self path]];</span><br><span class="line"></span><br><span class="line">[dbQueue inDatabase:^(FMDatabase * _Nonnull db) &#123;</span><br><span class="line">    NSLog(@&quot;11111111&quot;);</span><br><span class="line">    sleep(1);</span><br><span class="line">    </span><br><span class="line">    FMResultSet *rs &#x3D; [db executeQuery:@&quot;select rowid, * from city&quot;];</span><br><span class="line">    while ([rs next]) &#123;</span><br><span class="line">        NSLog(@&quot;%@&quot;, [rs resultDictionary]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    NSLog(@&quot;222222222&quot;);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">[dbQueue inDatabase:^(FMDatabase * _Nonnull db) &#123;</span><br><span class="line">    NSLog(@&quot;333333&quot;);</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 可变参数</span><br><span class="line">    FMResultSet *rs0 &#x3D; [db executeQuery:@&quot;select * from city where name&#x3D;?&quot;, @&quot;北京&quot;];</span><br><span class="line">    while ([rs0 next]) &#123;</span><br><span class="line">        NSLog(@&quot;%@&quot;, [rs0 resultDictionary]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    NSLog(@&quot;444444&quot;);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[dbQueue inTransaction:^(FMDatabase * _Nonnull db, BOOL * _Nonnull rollback) &#123;</span><br><span class="line">  </span><br><span class="line">    BOOL success &#x3D; [db executeUpdateWithFormat:@&quot;insert into city (id, code, name, level, parentCode, first_char) values (%d, %d, %@, %d, %d, %@)&quot;, 1, 1, @&quot;哈哈哈&quot;, 2, 0, @&quot;h&quot;];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    if (!success) &#123;</span><br><span class="line">        *rollback &#x3D; YES;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    FMResultSet *rs &#x3D; [db executeQuery:@&quot;SELECT * FROM city&quot;];</span><br><span class="line">    while ([rs next]) &#123;</span><br><span class="line">        NSLog(@&quot;%@&quot;, [rs resultDictionary]);</span><br><span class="line">    &#125;</span><br><span class="line">    [rs close];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p>分为两部分讲</p>
<ul>
<li>初始化</li>
<li>常用方法</li>
</ul>
<h3 id="FMDatabaseQueue初始化"><a href="#FMDatabaseQueue初始化" class="headerlink" title="FMDatabaseQueue初始化"></a>FMDatabaseQueue初始化</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+ databaseQueueWithPath:</span><br><span class="line">+ databaseQueueWithURL:</span><br><span class="line">+ databaseQueueWithPath:flags:</span><br><span class="line">+ databaseQueueWithURL:flags:</span><br><span class="line">– initWithPath:</span><br><span class="line">– initWithURL:</span><br><span class="line">– initWithPath:flags:</span><br><span class="line">– initWithURL:flags:</span><br><span class="line">– initWithPath:flags:vfs:</span><br><span class="line">– initWithURL:flags:vfs:</span><br><span class="line">+ databaseClass</span><br></pre></td></tr></table></figure>

<p>可以看到这么多方法，但最后都是调用的 <code>– initWithURL:flags:vfs:</code> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)initWithPath:(NSString*)aPath flags:(int)openFlags vfs:(NSString *)vfsName &#123;</span><br><span class="line">    self &#x3D; [super init];</span><br><span class="line">    </span><br><span class="line">    if (self !&#x3D; nil) &#123;</span><br><span class="line">        </span><br><span class="line">        _db &#x3D; [[[self class] databaseClass] databaseWithPath:aPath];</span><br><span class="line">        FMDBRetain(_db);</span><br><span class="line">        </span><br><span class="line">#if SQLITE_VERSION_NUMBER &gt;&#x3D; 3005000</span><br><span class="line">        BOOL success &#x3D; [_db openWithFlags:openFlags vfs:vfsName];</span><br><span class="line">#else</span><br><span class="line">        BOOL success &#x3D; [_db open];</span><br><span class="line">#endif</span><br><span class="line">        if (!success) &#123;</span><br><span class="line">            NSLog(@&quot;Could not create database queue for path %@&quot;, aPath);</span><br><span class="line">            FMDBRelease(self);</span><br><span class="line">            return 0x00;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        _path &#x3D; FMDBReturnRetained(aPath);</span><br><span class="line">        </span><br><span class="line">        _queue &#x3D; dispatch_queue_create([[NSString stringWithFormat:@&quot;fmdb.%@&quot;, self] UTF8String], NULL);</span><br><span class="line">        dispatch_queue_set_specific(_queue, kDispatchQueueSpecificKey, (__bridge void *)self, NULL);</span><br><span class="line">        _openFlags &#x3D; openFlags;</span><br><span class="line">        _vfsName &#x3D; [vfsName copy];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>调用FMDatabase生成数据库对象_db</li>
<li>执行 <code>[_db open]</code> 打开数据库</li>
<li>创建一个串行队列 _queue</li>
<li>dispatch_queue_set_specific设置队列的私有数据，把self和<code>_queue</code>绑定一起，后面可以通过dispatch_get_specific获取到当前<code>_queue</code>队列绑定的self对象</li>
</ol>
<h3 id="常用操作方法"><a href="#常用操作方法" class="headerlink" title="常用操作方法"></a>常用操作方法</h3><h4 id="inDatabase"><a href="#inDatabase" class="headerlink" title="- inDatabase:"></a>- inDatabase:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">- (void)inDatabase:(__attribute__((noescape)) void (^)(FMDatabase *db))block &#123;</span><br><span class="line">#ifndef NDEBUG</span><br><span class="line">    &#x2F;* Get the currently executing queue (which should probably be nil, but in theory could be another DB queue</span><br><span class="line">     * and then check it against self to make sure we&#39;re not about to deadlock. *&#x2F;</span><br><span class="line">    FMDatabaseQueue *currentSyncQueue &#x3D; (__bridge id)dispatch_get_specific(kDispatchQueueSpecificKey);</span><br><span class="line">    assert(currentSyncQueue !&#x3D; self &amp;&amp; &quot;inDatabase: was called reentrantly on the same queue, which would lead to a deadlock&quot;);</span><br><span class="line">#endif</span><br><span class="line">    </span><br><span class="line">    FMDBRetain(self);</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 同步串行队列</span><br><span class="line">    dispatch_sync(_queue, ^() &#123;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; db 已经open</span><br><span class="line">        FMDatabase *db &#x3D; [self database];</span><br><span class="line">        </span><br><span class="line">        block(db);</span><br><span class="line">        </span><br><span class="line">        if ([db hasOpenResultSets]) &#123;</span><br><span class="line">            NSLog(@&quot;Warning: there is at least one open result set around after performing [FMDatabaseQueue inDatabase:]&quot;);</span><br><span class="line">            </span><br><span class="line">#if defined(DEBUG) &amp;&amp; DEBUG</span><br><span class="line">            NSSet *openSetCopy &#x3D; FMDBReturnAutoreleased([[db valueForKey:@&quot;_openResultSets&quot;] copy]);</span><br><span class="line">            for (NSValue *rsInWrappedInATastyValueMeal in openSetCopy) &#123;</span><br><span class="line">                FMResultSet *rs &#x3D; (FMResultSet *)[rsInWrappedInATastyValueMeal pointerValue];</span><br><span class="line">                NSLog(@&quot;query: &#39;%@&#39;&quot;, [rs query]);</span><br><span class="line">            &#125;</span><br><span class="line">#endif</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    FMDBRelease(self);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行数据库操作</p>
<ol>
<li>开启一个同步串行队列</li>
<li>获取db对象，如果没有打开数据库，则执行open操作</li>
<li>把db对象通过block传给调用方执行相应操作</li>
</ol>
<h4 id="inTransaction"><a href="#inTransaction" class="headerlink" title="- inTransaction:"></a>- inTransaction:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;&#x2F; 开启事务</span><br><span class="line">- (void)inTransaction:(__attribute__((noescape)) void (^)(FMDatabase *db, BOOL *rollback))block &#123;</span><br><span class="line">    [self beginTransaction:FMDBTransactionExclusive withBlock:block];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)inDeferredTransaction:(__attribute__((noescape)) void (^)(FMDatabase *db, BOOL *rollback))block &#123;</span><br><span class="line">    [self beginTransaction:FMDBTransactionDeferred withBlock:block];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)inExclusiveTransaction:(__attribute__((noescape)) void (^)(FMDatabase *db, BOOL *rollback))block &#123;</span><br><span class="line">    [self beginTransaction:FMDBTransactionExclusive withBlock:block];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)inImmediateTransaction:(__attribute__((noescape)) void (^)(FMDatabase * _Nonnull, BOOL * _Nonnull))block &#123;</span><br><span class="line">    [self beginTransaction:FMDBTransactionImmediate withBlock:block];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用inTransaction可以执行事务操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;&#x2F; 开始事务处理</span><br><span class="line">- (void)beginTransaction:(FMDBTransaction)transaction withBlock:(void (^)(FMDatabase *db, BOOL *rollback))block &#123;</span><br><span class="line">    FMDBRetain(self);</span><br><span class="line">    dispatch_sync(_queue, ^() &#123; </span><br><span class="line">        </span><br><span class="line">        BOOL shouldRollback &#x3D; NO;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 根据事务模式，执行事务begin操作</span><br><span class="line">        switch (transaction) &#123;</span><br><span class="line">            case FMDBTransactionExclusive:</span><br><span class="line">                [[self database] beginTransaction];</span><br><span class="line">                break;</span><br><span class="line">            case FMDBTransactionDeferred:</span><br><span class="line">                [[self database] beginDeferredTransaction];</span><br><span class="line">                break;</span><br><span class="line">            case FMDBTransactionImmediate:</span><br><span class="line">                [[self database] beginImmediateTransaction];</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; begin 之后 交给block处理数据</span><br><span class="line">        block([self database], &amp;shouldRollback);</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; 如果rollback&#x3D;yes，执行 &#96;rollback transaction&#96;</span><br><span class="line">        &#x2F;&#x2F; 反之正常commit，执行 &#96;commit transaction&#96;</span><br><span class="line">        if (shouldRollback) &#123;</span><br><span class="line">            [[self database] rollback];</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            [[self database] commit];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    FMDBRelease(self);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>开启同步串行队列</li>
<li>根据事务的type执行对应的事务开启</li>
<li>把db对象和&amp;rollback通过blcok传给调用方</li>
<li>根据rollback状态，如果rollback，则执行db的rollback，<code>rollback transaction</code>回退操作。如果rollback==NO，则执行commit，<code>commit transaction</code>正常提交</li>
</ol>
<p>下面看一下事务的几种模式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">typedef NS_ENUM(NSInteger, FMDBTransaction) &#123;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 事务开始执行，就获取EXCLUSIVE锁。这时，其他连接无法进行任何读写操作</span><br><span class="line">    FMDBTransactionExclusive,</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 事务开始执行时，不预先获取任何锁。当进行读操作，获取SHARED LOCK锁；当进行第一次写操作，获取RESERVED锁</span><br><span class="line">    FMDBTransactionDeferred,</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 事务开始执行，就获取RESERVED锁。这时，其他连接只能进行读操作</span><br><span class="line">    FMDBTransactionImmediate,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>inTrannsaction:</code> 默认调用的是FMDBTransactionExclusive锁，其他连接无法执行</p>
<h4 id="inSavePoint"><a href="#inSavePoint" class="headerlink" title="- inSavePoint:"></a>- inSavePoint:</h4><p>事务设置保留点，可以自定义方便回退</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">- (NSError*)inSavePoint:(__attribute__((noescape)) void (^)(FMDatabase *db, BOOL *rollback))block &#123;</span><br><span class="line">#if SQLITE_VERSION_NUMBER &gt;&#x3D; 3007000</span><br><span class="line">    static unsigned long savePointIdx &#x3D; 0;</span><br><span class="line">    __block NSError *err &#x3D; 0x00;</span><br><span class="line">    FMDBRetain(self);</span><br><span class="line">    dispatch_sync(_queue, ^() &#123; </span><br><span class="line">        </span><br><span class="line">        NSString *name &#x3D; [NSString stringWithFormat:@&quot;savePoint%ld&quot;, savePointIdx++];</span><br><span class="line">        </span><br><span class="line">        BOOL shouldRollback &#x3D; NO;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; 1. 执行 &quot; savepoint &#39;dbSavePointx&#39; &quot; 设置保留点</span><br><span class="line">        if ([[self database] startSavePointWithName:name error:&amp;err]) &#123;</span><br><span class="line">            </span><br><span class="line">            &#x2F;&#x2F; 2. 回调是否rollback</span><br><span class="line">            block([self database], &amp;shouldRollback);</span><br><span class="line">            </span><br><span class="line">            &#x2F;&#x2F; 3. 回退 执行 &quot; rollback transaction to savepoint &#39;dbSavePointx&#39; &quot;</span><br><span class="line">            if (shouldRollback) &#123;</span><br><span class="line">                &#x2F;&#x2F; We need to rollback and release this savepoint to remove it</span><br><span class="line">                [[self database] rollbackToSavePointWithName:name error:&amp;err];</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; 4. 释放保留点 &quot; release savepoint &#39;dbSavePintx&#39; &quot;</span><br><span class="line">            [[self database] releaseSavePointWithName:name error:&amp;err];</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    FMDBRelease(self);</span><br><span class="line">    return err;</span><br><span class="line">#else</span><br><span class="line">    NSString *errorMessage &#x3D; NSLocalizedStringFromTable(@&quot;Save point functions require SQLite 3.7&quot;, @&quot;FMDB&quot;, nil);</span><br><span class="line">    if (_db.logsErrors) NSLog(@&quot;%@&quot;, errorMessage);</span><br><span class="line">    return [NSError errorWithDomain:@&quot;FMDatabase&quot; code:0 userInfo:@&#123;NSLocalizedDescriptionKey : errorMessage&#125;];</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>执行 <code>savepoint &#39;dbSavePointx&#39;</code> 设置保留点</li>
<li>回调是否rollback</li>
<li>回退 执行 <code>rollback transaction to savepoint &#39;dbSavePointx&#39;</code></li>
<li>释放保留点 <code>release savepoint &#39;dbSavePintx&#39;</code></li>
</ol>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://github.com/ccgus/fmdb" target="_blank" rel="noopener">FMDB github</a></p>
<p><a href="http://ccgus.github.io/fmdb/html/index.html" target="_blank" rel="noopener">FMDB Reference</a></p>
<p><a href="https://sqlite.org/c3ref/intro.html" target="_blank" rel="noopener">sqlite3</a></p>
<p><a href="https://github.com/gaonian/HexoDocument/blob/master/iOS/SQLite/SQLite%E5%B8%B8%E7%94%A8API(C).md" target="_blank" rel="noopener">sqlite常用api</a></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">GN</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://lmzcool.top/2020/04/06/FMDB%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">http://lmzcool.top/2020/04/06/FMDB%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://lmzcool.top" target="_blank">GN</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/CDN/img/material-4.png" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/04/06/SQLite%E5%B8%B8%E7%94%A8API(C)/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN/img/material-8.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">SQLite常用API（C）</div></div></a></div><div class="next-post pull_right"><a href="/2020/04/06/SQLite%E6%8E%A5%E5%8F%A3%E4%BB%8B%E7%BB%8D(C)/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN/img/material-2.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">SQLite接口介绍</div></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify: false,
  verify: false,
  appId: 'v26lyi3lmFjLAjSuqbPuAQWf-gzGzoHsz',
  appKey: 'kXNYMLXOoEDtuSEqWE7SadDa',
  placeholder: 'Please leave your footprints',
  avatar: 'monsterid',
  meta: guest_info,
  pageSize: '10',
  lang: 'zh-CN',
  recordIP: false,
  serverURLs: ''
});</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2020 By GN</div><div class="icp"><a><span>京ICP备19014027号</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>