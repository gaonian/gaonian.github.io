<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>iOS 10 Notification Extension | GN</title><meta name="description" content="iOS 10 Notification Extension"><meta name="author" content="GN"><meta name="copyright" content="GN"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="iOS 10 Notification Extension"><meta name="twitter:description" content="iOS 10 Notification Extension"><meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/1868661-21c02300372eabb1.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><meta property="og:type" content="article"><meta property="og:title" content="iOS 10 Notification Extension"><meta property="og:url" content="http://lmzcool.top/2020/04/06/iOS10Notification/"><meta property="og:site_name" content="GN"><meta property="og:description" content="iOS 10 Notification Extension"><meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1868661-21c02300372eabb1.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://lmzcool.top/2020/04/06/iOS10Notification/"><link rel="prev" title="Fishhook使用和源码解析" href="http://lmzcool.top/2020/04/06/fishHook/"><link rel="next" title="Linux用户组" href="http://lmzcool.top/2020/04/06/Linux%E7%94%A8%E6%88%B7%E7%BB%84/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: false,
  highlightLang: false,
  highlightShrink: 'none',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">15</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">4</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-UNNotificationAttachment-（通知附件）"><span class="toc-number">2.</span> <span class="toc-text">1. UNNotificationAttachment （通知附件）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-UNNotificationServiceExtension-（通知服务扩展）"><span class="toc-number">3.</span> <span class="toc-text">2. UNNotificationServiceExtension （通知服务扩展）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-UNNotificationContentExtension-（通知内容扩展）"><span class="toc-number">4.</span> <span class="toc-text">3. UNNotificationContentExtension （通知内容扩展）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-结合使用两个扩展"><span class="toc-number">5.</span> <span class="toc-text">4. 结合使用两个扩展</span></a></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(http://upload-images.jianshu.io/upload_images/1868661-21c02300372eabb1.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">GN</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">iOS 10 Notification Extension</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-04-06 19:28:59"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-04-06</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-05-13 21:57:55"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-05-13</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/iOS/">iOS</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/2020/04/06/iOS10Notification/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/2020/04/06/iOS10Notification/" itemprop="commentCount"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>iOS10对推送通知增加了一些功能，用户可以对推送的内容增加附件（图片／音频／视频），也可以自定义视图更美观的展示推送内容。</p>
<ul>
<li>UNNotificationServiceExtension （通知服务扩展）</li>
<li>UNNotificationContentExtension （通知内容扩展）<br>ps：简单来说，UNNotificationServiceExtension是用来下载附件的扩展，UNNotificationContentExtension用来自定义视图的扩展</li>
</ul>
<h2 id="1-UNNotificationAttachment-（通知附件）"><a href="#1-UNNotificationAttachment-（通知附件）" class="headerlink" title="1. UNNotificationAttachment （通知附件）"></a>1. UNNotificationAttachment （通知附件）</h2><p>A UNNotificationAttachment object contains audio, image, or video content to display alongside the notification content. Your app always supplies attachments. For local notifications, the app adds attachments when creating the rest of the notification’s content. You can add attachments to a remote notification by implementing a notification service extension, as represented by the UNNotificationServiceExtension class.<br>用来管理通知附件，格式支持图片，音频，视频。格式的大小也有限制</p>
<p><img src="/" class="lazyload" data-src="http://upload-images.jianshu.io/upload_images/1868661-9bafd854693406d0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"  alt="image"></p>
<ul>
<li>本地通知<br>  直接把要展示的附件添加到content里面即可<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;设置content</span><br><span class="line">UNMutableNotificationContent *content &#x3D; [[UNMutableNotificationContent alloc] init];</span><br><span class="line">content.title &#x3D; @&quot;这是title&quot;;</span><br><span class="line">content.subtitle &#x3D; @&quot;这是subtitle&quot;;</span><br><span class="line">content.body &#x3D; @&quot;这是body&quot;;</span><br><span class="line">&#x2F;&#x2F;设置附件</span><br><span class="line">UNNotificationAttachment *attachment &#x3D; [UNNotificationAttachment attachmentWithIdentifier:@&quot;atta1&quot; URL:*这里为本地文件地址* options:nil error:nil];</span><br><span class="line">if (attachment) &#123;</span><br><span class="line">    &#x2F;&#x2F;添加附件到content</span><br><span class="line">    content.attachments &#x3D; @[attachment];</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;添加推送到request</span><br><span class="line">UNNotificationRequest *request &#x3D; [UNNotificationRequest requestWithIdentifier:@&quot;request_id1&quot; content:content trigger:nil];</span><br><span class="line">[[UNUserNotificationCenter currentNotificationCenter] addNotificationRequest:request withCompletionHandler:^(NSError * _Nullable error) &#123;</span><br><span class="line">    NSLog(@&quot;添加推送 : %@&quot;, error ? [NSString stringWithFormat:@&quot;error : %@&quot;, error] : @&quot;success&quot;);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></li>
<li>远程推送<br>远程推送需要实现UNNotificationServiceExtension这个扩展，在扩展里面监听通知内容，拦截通知内的附件url，进行下载，然后在添加到attachment内，回调，通知展示。一会会专门讲这个。（ ps：平常项目开发中肯定会有远程推送，所以必须是要实现UNNotificationServiceExtension这个扩展才能展示附件。）</li>
</ul>
<h2 id="2-UNNotificationServiceExtension-（通知服务扩展）"><a href="#2-UNNotificationServiceExtension-（通知服务扩展）" class="headerlink" title="2. UNNotificationServiceExtension （通知服务扩展）"></a>2. UNNotificationServiceExtension （通知服务扩展）</h2><p>A UNNotificationServiceExtension object, the principle class for a Notification Service app extension, lets you process the payload of a remote (sometimes called push) notification before it is delivered to the user.<br><img src="/" class="lazyload" data-src="http://upload-images.jianshu.io/upload_images/1868661-21c02300372eabb1.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"  alt="image"><br>原来的逻辑是服务器发送apns给苹果，苹果直接把内容推给用户展示。现在增加了ServiceExtension这一步骤，等于是苹果推给用户过程中被拦截了，可以对推送内容增加一些扩展，例如附件的下载等，然后处理完毕之后再展示到用户手机。<br>需要注意的一点就是在处理推送内容的时候，只有30s的时间去下载一些多媒体信息。如果因为网络状态或者一些其他的原因，30s内没有处理完毕，则推送会按原来的形式直接展示处理。就是说，本来你准备去下载图片然后展示，如果超时，则展示出来的是没有图片的。</p>
<p>具体实现步骤如下：</p>
<ul>
<li><p>确定服务器推送格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;aps&quot; : &#123;</span><br><span class="line">        &quot;alert&quot;: &#123;</span><br><span class="line">            &quot;title&quot;: &quot;这是title&quot;,</span><br><span class="line">            &quot;body&quot;: &quot;这是body&quot;       &#x2F;&#x2F;推送主体内容</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;badge&quot;: 1,</span><br><span class="line">        &quot;sound&quot;: &quot;default&quot;,</span><br><span class="line">        &quot;mutable-content&quot;: &quot;1&quot;,        &#x2F;&#x2F;可变内容</span><br><span class="line">        &quot;imageUrl&quot;:  &quot;http:&#x2F;&#x2F;***.jpg&quot;  &#x2F;&#x2F;图片url</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意的是，如果想改变推送内容，必须要在aps内增加<code>&quot;mutable-content&quot;: &quot;1&quot;</code>字段，如果没有此字段，则直接显示推送内容，不会处理扩展里的实现。<br><code>imageUrl</code>是附件的链接，这里以图片为例。此字段可以写在aps内外都可以。</p>
</li>
<li><p>创建UNNotificationServiceExtension扩展<br>1.File -&gt; New -&gt; Target<br>2.<br><img src="/" class="lazyload" data-src="http://upload-images.jianshu.io/upload_images/1868661-f605d7657dcfe63b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"  alt=""><br>3.填上名字，finish即可</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="http://upload-images.jianshu.io/upload_images/1868661-2459e746f2aece21.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"  alt=""><br>成功之后会自动增加这么多东西，而且在<code>NotificationService.m</code>里重写了下面两个方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (void)didReceiveNotificationRequest:(UNNotificationRequest *)request withContentHandler:(void (^)(UNNotificationContent * _Nonnull))contentHandler &#123;</span><br><span class="line">    self.contentHandler &#x3D; contentHandler;</span><br><span class="line">    self.bestAttemptContent &#x3D; [request.content mutableCopy];</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; Modify the notification content here...</span><br><span class="line">    self.bestAttemptContent.title &#x3D; [NSString stringWithFormat:@&quot;%@ [modified]&quot;, self.bestAttemptContent.title];</span><br><span class="line">    </span><br><span class="line">    self.contentHandler(self.bestAttemptContent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)serviceExtensionTimeWillExpire &#123;</span><br><span class="line">    &#x2F;&#x2F; Called just before the extension will be terminated by the system.</span><br><span class="line">    &#x2F;&#x2F; Use this as an opportunity to deliver your &quot;best attempt&quot; at modified content, otherwise the original push payload will be used.</span><br><span class="line">    self.contentHandler(self.bestAttemptContent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之后就是主要重写这两个方法来实现扩展，等下会专门讲解这方法。</p>
<ul>
<li><p>为UNNotificationServiceExtension添加证书<br>创建成功扩展之后会看到它的bundle id是主程序的bundle id + .扩展名(例如：com.123.456.Notification)。在苹果证书平台新建appID，并添加对应的描述文件，安装即可。</p>
</li>
<li><p>实现扩展方法<br>收到推送的时候会自动调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"> - (void)didReceiveNotificationRequest:(UNNotificationRequest *)request withContentHandler:(void (^)(UNNotificationContent *contentToDeliver))contentHandler &#123;</span><br><span class="line">    &#x2F;&#x2F;在这个方法里面，重写通知内容，在此下载附件并展示</span><br><span class="line">    &#x2F;&#x2F; Modify the notification content here...</span><br><span class="line">    self.bestAttemptContent.title &#x3D; [NSString stringWithFormat:@&quot;%@&quot;, self.bestAttemptContent.title];</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;取出推送的数据</span><br><span class="line">    NSDictionary *dic &#x3D; self.bestAttemptContent.userInfo;</span><br><span class="line">    &#x2F;&#x2F;获取要显示的图片url</span><br><span class="line">    NSString *imgUrl &#x3D; dic[@&quot;aps&quot;][@&quot;imageUrl&quot;];</span><br><span class="line">    NSURL *url &#x3D; [NSURL URLWithString:imgUrl];</span><br><span class="line">    &#x2F;&#x2F;取出后缀名</span><br><span class="line">    NSString *ext &#x3D; [imgUrl pathExtension];</span><br><span class="line">    &#x2F;&#x2F;下载图片并存储到本地沙盒</span><br><span class="line">    NSURLSession *session &#x3D; [NSURLSession sharedSession];</span><br><span class="line">    NSURLSessionDownloadTask *task &#x3D; [session downloadTaskWithURL:url completionHandler:^(NSURL * _Nullable location, NSURLResponse * _Nullable response, NSError * _Nullable error) &#123;</span><br><span class="line">        if (error) &#123;</span><br><span class="line">            NSLog(@&quot;download - %@&quot;,error);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F;沙盒创建download文件夹，存储附件信息</span><br><span class="line">            NSString *path &#x3D; [[NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject] stringByAppendingPathComponent:@&quot;download&quot;];</span><br><span class="line">            NSFileManager *manager &#x3D; [NSFileManager defaultManager];</span><br><span class="line">            if (![manager fileExistsAtPath:path]) &#123;</span><br><span class="line">                [manager createDirectoryAtPath:path withIntermediateDirectories:YES attributes:nil error:nil];</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F;移动下载的路径到本地创建的路径</span><br><span class="line">            NSURL *localUrl &#x3D; [NSURL fileURLWithPath:[path stringByAppendingPathExtension:ext]];</span><br><span class="line">            NSError *moveError &#x3D; nil;</span><br><span class="line">            [manager moveItemAtURL:location toURL:localUrl error:&amp;moveError];</span><br><span class="line">            if (moveError) &#123;</span><br><span class="line">                NSLog(@&quot;move - %@&quot;,moveError);</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F;给通知的内容设置附件内容</span><br><span class="line">            UNNotificationAttachment *attachment &#x3D; [UNNotificationAttachment attachmentWithIdentifier:@&quot;remote-attachment1&quot; URL:localUrl options:nil error:nil];</span><br><span class="line">            if (attachment) &#123;</span><br><span class="line">                &#x2F;&#x2F;如果有附件，传递给通知</span><br><span class="line">                self.bestAttemptContent.attachments &#x3D; @[attachment];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        self.contentHandler(self.bestAttemptContent);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [task resume];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果处理时间太长，超过30s，则会调用以下的方法，把通知内容直接回调出去，不做处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;如果处理时间太长，直接把apns展示出来</span><br><span class="line"> - (void)serviceExtensionTimeWillExpire &#123;</span><br><span class="line">    &#x2F;&#x2F; Called just before the extension will be terminated by the system.</span><br><span class="line">    &#x2F;&#x2F; Use this as an opportunity to deliver your &quot;best attempt&quot; at modified content, otherwise the original push payload will be used.</span><br><span class="line">    self.contentHandler(self.bestAttemptContent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，UNNotificationServiceExtension这个扩展就基本实现完毕了，可以按照第一步的推送格式推一个试试。有3DTouch的设备，重按推送内容 可以看到一个大图直接在最上面，下面是推送的内容。<br>附图：<br><img src="http://upload-images.jianshu.io/upload_images/1868661-cc3d9a1f4df0771a.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="
![](http://upload-images.jianshu.io/upload_images/1868661-0ac358ca44c1d63d.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
"></p>
</li>
</ul>
<h2 id="3-UNNotificationContentExtension-（通知内容扩展）"><a href="#3-UNNotificationContentExtension-（通知内容扩展）" class="headerlink" title="3. UNNotificationContentExtension （通知内容扩展）"></a>3. UNNotificationContentExtension （通知内容扩展）</h2><p>The UNNotificationContentExtension protocol lets you present a custom interface for your app’s notifications. You adopt this protocol in custom UIViewController subclasses, using the view controller’s view to display the notification contents. You deliver your view controller class inside a Notification Content extension.<br>iOS10推送提供了一块区域让用户自定义view去更好的展示推送内容，信息量更大。想要自定义view则必须要实现<code>UNNotificationContentExtension</code>这个扩展，但是貌似只有支持3DTouch的设备通过重压或者下拉才能展示出来自定义的view。注意，这个自定义的view只支持展示功能，不能交互。</p>
<p>具体实现步骤如下：</p>
<ul>
<li>创建UNNotificationContentExtension扩展<br>1.File -&gt; New -&gt; Target<br>2.<br><img src="/" class="lazyload" data-src="http://upload-images.jianshu.io/upload_images/1868661-c8f21b20cfc0bca2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"  alt=""><br>3.填上名字，finish即可</li>
</ul>
<p><img src="/" class="lazyload" data-src="http://upload-images.jianshu.io/upload_images/1868661-e013b44d5f284692.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"  alt=""><br>和通知服务扩展一样，系统会生成一些文件，这个需要注意的是plist里有很多可以配置的内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (void)didReceiveNotification:(UNNotification *)notification &#123;</span><br><span class="line">    &#x2F;&#x2F;在这个方面里给自定义的控件赋值</span><br><span class="line">    NSDictionary *dic &#x3D; notification.request.content.userInfo;</span><br><span class="line">    self.lbTitle.text &#x3D; @&quot;哈哈哈&quot;;</span><br><span class="line">    </span><br><span class="line">    self.imgLogo.backgroundColor &#x3D; [UIColor redColor];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>为UNNotificationContentExtension添加证书<br>创建成功扩展之后会看到它的bundle id是主程序的bundle id + .扩展名(例如：com.123.456.NotificationContent)。在苹果证书平台新建appID，并添加对应的描述文件，安装即可。<br>和UNNotificationServiceExtension扩展一样，都需要新创建证书</li>
</ul>
<ul>
<li>实现扩展方法<br>收到推送的时候会自动调用<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> - (void)didReceiveNotification:(UNNotification *)notification &#123;</span><br><span class="line">    &#x2F;&#x2F;在这个方面里给自定义的控件赋值</span><br><span class="line">    NSDictionary *dic &#x3D; notification.request.content.userInfo;</span><br><span class="line">    self.lbTitle.text &#x3D; @&quot;哈哈哈&quot;;</span><br><span class="line"></span><br><span class="line">    self.imgLogo.backgroundColor &#x3D; [UIColor redColor];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
拿到推送的内容，对自定义的控件赋值展示。<br>至此，通知内容扩展创建完毕，下面来讲一下plist，以及需要注意的事项</li>
</ul>
<p><img src="/" class="lazyload" data-src="http://upload-images.jianshu.io/upload_images/1868661-45810cf9227078d3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"  alt="通知内容扩展plist"><br>上图是创建扩展的时候自带的plist文件，<code>UNNotificationExtensionDefaultContentHidden</code>这个属性是自己添加的，意思就是隐藏系统自己的推送内容。当自定义的内容跟系统的重合了，可以用这个属性把系统的隐藏了，只展示自定义的。<br><code>UNNotificationExtensionInitialContentSizeRatio</code>这个属性是自定义view的比例，默认1是宽高比例相同。可以根据自定义view的尺寸在这里改变比例。<br><code>UNNotificationExtensionCategory</code>这个categoryID很重要，想要展示自定义的内容扩展，必须要保证aps里面的category和plist配置的一样。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;aps&quot; : &#123;</span><br><span class="line">        &quot;alert&quot;: &#123;</span><br><span class="line">            &quot;title&quot;: &quot;这是title&quot;,</span><br><span class="line">            &quot;body&quot;: &quot;这是body&quot;       &#x2F;&#x2F;推送主体内容</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;badge&quot;: 1,</span><br><span class="line">        &quot;sound&quot;: &quot;default&quot;,</span><br><span class="line">        &quot;mutable-content&quot;: &quot;1&quot;,        &#x2F;&#x2F;可变内容</span><br><span class="line">        &quot;category&quot;: &quot;myNotificationCategory&quot;,    &#x2F;&#x2F;categoryId</span><br><span class="line">        &quot;imageUrl&quot;:  &quot;http:&#x2F;&#x2F;***.jpg&quot;  &#x2F;&#x2F;图片url</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据这个id来展示不同的自定义内容。<code>UNNotificationExtensionCategory</code>也可以是一个数组，多个catogoryId对应一个自定义的view。<br><img src="/" class="lazyload" data-src="http://upload-images.jianshu.io/upload_images/1868661-724cc8d03e7db59b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"  alt=""></p>
<h2 id="4-结合使用两个扩展"><a href="#4-结合使用两个扩展" class="headerlink" title="4. 结合使用两个扩展"></a>4. 结合使用两个扩展</h2><p>在自定义view的时候，可以获取到推送内容以及附件信息，放到自定义的view中。简单的运用如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (void)didReceiveNotification:(UNNotification *)notification &#123;</span><br><span class="line">    </span><br><span class="line">    UNNotificationContent *content &#x3D; notification.request.content;</span><br><span class="line">    &#x2F;&#x2F;获取title</span><br><span class="line">    self.lbTitle.text &#x3D; content.title;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;获取到附件信息</span><br><span class="line">    UNNotificationAttachment *attachment &#x3D; content.attachments.firstObject;</span><br><span class="line">    if (attachment) &#123;</span><br><span class="line">        &#x2F;&#x2F;告诉系统，我们要使用附件信息</span><br><span class="line">        if ([attachment.URL startAccessingSecurityScopedResource]) &#123;</span><br><span class="line">            self.imgLogo.image &#x3D; [UIImage imageWithContentsOfFile:attachment.URL.path];</span><br><span class="line">            &#x2F;&#x2F;使用完毕之后，告诉系统，使用完毕，可以关闭了</span><br><span class="line">            [attachment.URL stopAccessingSecurityScopedResource];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">GN</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://lmzcool.top/2020/04/06/iOS10Notification/">http://lmzcool.top/2020/04/06/iOS10Notification/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://lmzcool.top" target="_blank">GN</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://user-gold-cdn.xitu.io/2020/5/11/1720422da38055a1?w=500&amp;h=500&amp;f=png&amp;s=23846" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/04/06/fishHook/"><img class="prev_cover lazyload" data-src="https://raw.githubusercontent.com/gaonian/HexoDocument/master/iOS/fishhook_image/fishhook_1.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Fishhook使用和源码解析</div></div></a></div><div class="next-post pull_right"><a href="/2020/04/06/Linux%E7%94%A8%E6%88%B7%E7%BB%84/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN/img/material-8.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Linux用户组</div></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify: false,
  verify: false,
  appId: 'v26lyi3lmFjLAjSuqbPuAQWf-gzGzoHsz',
  appKey: 'kXNYMLXOoEDtuSEqWE7SadDa',
  placeholder: 'Please leave your footprints',
  avatar: 'monsterid',
  meta: guest_info,
  pageSize: '10',
  lang: 'zh-CN',
  recordIP: false,
  serverURLs: ''
});</script></div></article></main><footer id="footer" style="background-image: url(http://upload-images.jianshu.io/upload_images/1868661-21c02300372eabb1.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2020 By GN</div><div class="icp"><a><span>京ICP备19014027号</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>